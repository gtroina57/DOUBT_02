<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DOUBT - Multi-Agent Debate</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    textarea { width: 100%; height: 200px; margin-top: 10px; }
    .tab { display: none; }
    .tab.active { display: block; }
    .tabs button { margin-right: 10px; padding: 10px; }
    .accordion { cursor: pointer; padding: 10px; background-color: #eee; border: 1px solid #ccc; margin-top: 5px; }
    .accordion-content { display: none; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>🤖 DOUBT - Debating, Observing, Understanding, Brainstorming Tutor</h2>

  <div class="tabs">
    <button onclick="showTab('setup')">1️⃣ Setup</button>
    <button onclick="showTab('intervention')">👤 User Intervention</button>
    <button onclick="showTab('run')">▶️ Run</button>
    <button onclick="showTab('log')">📝 Log</button>
  </div>

  <div id="setup" class="tab active">
    <h3>🎯 Step 1: Enter Debate Topic</h3>
    <input id="topicInput" type="text" placeholder="e.g. Is AI a threat to democracy?" size="60">
    <button onclick="setTopic()">Set Topic</button>
    <p id="taskStatus"></p>

    <h3>⚙️ Step 2: Agent Config (Mockup)</h3>
    <div class="accordion" onclick="toggleAccordion(this)">Agent: Alice</div>
    <div class="accordion-content">
      <label>Description:</label><br><input value="Expert in utilitarian ethics"><br>
      <label>System Message:</label><br><textarea>System message for Alice</textarea><br>
      <label>Temperature:</label><br><input type="range" min="0" max="1" step="0.1" value="0.7"><br>
      <label>Model:</label><br><input value="gpt-4"><br>
      <label>Tools:</label><br><input value="none">
    </div>
  </div>

  <div id="intervention" class="tab">
    <h3>👤 Send Message to Debate</h3>
    <input id="messageInput" type="text" placeholder="Wait for your turn..." size="60" disabled>
    <button id="sendButton" onclick="sendMessage()" disabled>Send</button>
  </div>

  <div id="run" class="tab">
    <h3>▶️ Run Debate</h3>
    <button onclick="runDebate()">Run</button>
    <button onclick="loadTeam()">Load Team</button>
  </div>

  <div id="log" class="tab">
    <h3>📝 Conversation Log</h3>
    <textarea id="logArea" readonly></textarea>
  </div>

<script>
  let currentTab = 'setup';
  let audioQueue = [];
  let isPlaying = false;
  const ws = new WebSocket("wss://doubt-02.onrender.com/ws");

  ws.onopen = () => log("✅ Connected to server");

  ws.onmessage = (event) => {
    if (event.data === "__USER_PROXY_TURN__") {
      log("🎤 Moderator gives you the floor.");
      document.getElementById("messageInput").disabled = false;
      document.getElementById("sendButton").disabled = false;
      return;
    }

    if (event.data.startsWith("__AUDIO_URL__/")) {
      audioQueue.push(event.data.replace("__AUDIO_URL__", ""));
      playNextAudio();
      return;
    }

    log(event.data);
  };

  function setTopic() {
    const topic = document.getElementById("topicInput").value.trim();
    if (topic && ws.readyState === WebSocket.OPEN) {
      ws.send(`__SET_TASK1__:${topic}`);
      document.getElementById("taskStatus").textContent = `✅ Topic sent: ${topic}`;
    }
  }

  function sendMessage() {
    const input = document.getElementById("messageInput");
    const message = input.value.trim();
    if (message && ws.readyState === WebSocket.OPEN) {
      ws.send(message);
      log("🧑 You: " + message);
      input.value = "";
      input.disabled = true;
      document.getElementById("sendButton").disabled = true;
    }
  }

  function runDebate() {
    log("▶️ Run requested (handled by backend)");
  }

  function loadTeam() {
    log("📦 Load requested (handled by backend)");
  }

  function log(msg) {
    const area = document.getElementById("logArea");
    area.value += msg + "\n";
    area.scrollTop = area.scrollHeight;
  }

  function showTab(id) {
    document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  function toggleAccordion(element) {
    const content = element.nextElementSibling;
    content.style.display = (content.style.display === "block") ? "none" : "block";
  }

  function playNextAudio() {
    if (isPlaying || audioQueue.length === 0) return;
    const url = audioQueue.shift();
    const audio = new Audio(url);
    isPlaying = true;
    audio.onended = () => { isPlaying = false; playNextAudio(); };
    audio.onerror = () => { isPlaying = false; playNextAudio(); log("❌ Error playing audio."); };
    audio.play();
  }

  setInterval(() => {
    if (ws.readyState === WebSocket.OPEN) ws.send("__ping__");
  }, 20000);
</script>

</body>
</html>
