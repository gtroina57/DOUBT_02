<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Multi-DOUBT</title>
  <style>
    /* [Same styling from your original file remains untouched] */
  </style>
</head>
<body>
  <h1>DOUBT</h1>
  <h2>Debating · Observing · Understanding · Brainstorming · Tutoring</h2>
  <div class="container">
    <div>
      <h3>Choose Language and Configuration</h3>
      <div class="input-row">
        <select id="languageSelector" onchange="filterConfigsByLanguage()">
          <option value="EN">English</option>
          <option value="IT">Italiano</option>
        </select>

        <select id="configSelector" onchange="setConfig()">
          <option>Loading...</option>
        </select>

        <button onclick="downloadDebateLog()">💾 Save Debate</button>
      </div>
    </div>

    <div>
      <h3>Set Debate Topic</h3>
      <div class="input-row">
        <input id="topicInput" placeholder="Enter debate topic..." type="text" />
        <button onclick="setTopic()">🎯 Set Topic</button>
      </div>
    </div>

    <div>
      <h3>Debate Log</h3>
      <textarea id="log" readonly placeholder="Debate log will appear here..."></textarea>
    </div>

    <div>
      <h3>Your Input</h3>
      <div class="input-row">
        <input id="messageInput" placeholder="Your response..." type="text" />
        <button id="sendButton" onclick="sendMessage()">📤 Send</button>
        <button onclick="startVoiceInput()">🎙 Voice Input</button>
      </div>
    </div>

    <div>
      <div class="progress-bar" id="audioProgress" style="display:none;"> 🔊 Playing... </div>
    </div>
  </div>

  <script>
    const ws = new WebSocket("wss://doubt-02.onrender.com/ws");
    const audioQueue = [];
    let isPlaying = false;
    let userHasTurn = false;
    let currentLanguage = "EN";
    let allConfigFiles = [];
    const debateLog = [];

    ws.onopen = () => {
      log("✅ Connected to debate server.");
    };

    ws.onmessage = (event) => {
      if (event.data === "__USER_PROXY_TURN__") {
        log("🎤 Moderator gives you the floor. You may speak now.");
        document.getElementById("messageInput").disabled = false;
        document.getElementById("sendButton").disabled = false;
        document.getElementById("messageInput").focus();
        return;
      }

      if (event.data.startsWith("__AUDIO_URL__/")) {
        const audioUrl = "https://doubt-02.onrender.com/" + event.data.replace("__AUDIO_URL__/", "");
        audioQueue.push(audioUrl);
        if (!isPlaying) playNextAudio();
        return;
      }

      log("📩 " + event.data);
    };

    async function playNextAudio() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        return;
      }
      isPlaying = true;
      const url = audioQueue.shift();
      const audio = new Audio(url);

      await new Promise((resolve) => {
        audio.onended = audio.onerror = resolve;
        audio.play().catch(resolve);
      });

      isPlaying = false;
      playNextAudio();
    }

    function log(message, speaker = "system") {
      const logArea = document.getElementById("log");
      logArea.value += `[${speaker}] ${message}\n`;
      logArea.scrollTop = logArea.scrollHeight;

      debateLog.push({
        timestamp: new Date().toISOString(),
        speaker: speaker,
        message: message
      });
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const message = input.value.trim();
      if (!message || ws.readyState !== WebSocket.OPEN) return;

      log("🧑 You: " + message, "Giuseppe");
      userHasTurn = false;
      document.getElementById("messageInput").placeholder = "Wait for your turn...";
      ws.send("Giuseppe " + message + " XYZ");
      input.value = "";
      document.getElementById("sendButton").disabled = true;
    }

    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        log("❌ Speech recognition not supported in this browser.");
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();

      recognition.lang = (currentLanguage === "IT") ? "it-IT" : "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => log("🎤 Listening...");
      recognition.onerror = (event) => log("❌ Voice input error: " + event.error);

      recognition.onresult = (event) => {
        const speechResult = event.results[0][0].transcript.trim();
        log("🗣 You said: " speechResult);
        document.getElementById("messageInput").value = speechResult;
        sendMessage();
      };

      recognition.start();
    }

    async function fetchConfigFileList() {
      try {
        const res = await fetch("/list_configs");
        const data = await res.json();
        allConfigFiles = data.configs || [];
        filterConfigsByLanguage();
      } catch (error) {
        log("❌ Failed to fetch config list: " + error.message);
      }
    }

    function filterConfigsByLanguage() {
      currentLanguage = document.getElementById("languageSelector").value;
      const selector = document.getElementById("configSelector");
      selector.innerHTML = "";

      const filtered = allConfigFiles.filter(name =>
        name.endsWith(`${currentLanguage}.json`) || name.endsWith(`${currentLanguage}.JSON`)
      );

      if (filtered.length === 0) {
        const option = document.createElement("option");
        option.textContent = "No config available";
        option.disabled = true;
        selector.appendChild(option);
        return;
      }

      filtered.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        selector.appendChild(option);
      });

      selector.value = filtered[0];
      setConfig();
    }

    async function setConfig() {
      const selected = document.getElementById("configSelector").value;
      if (!selected) return;
      try {
        const res = await fetch("/set_config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: selected })
        });
        const result = await res.json();
        log("🛠️ Config selected: " + result.selected);
      } catch (e) {
        log("❌ Config set error: " + e.message);
      }
    }

    function setTopic() {
      const topic = document.getElementById("topicInput").value.trim();
      if (topic && ws.readyState === WebSocket.OPEN) {
        ws.send(`__SET_TASK1__:${topic}`);
        log("📘 Topic sent: " + topic);
      }
    }

    function downloadDebateLog() {
      const blob = new Blob([JSON.stringify(debateLog, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `debate_${new Date().toISOString().replace(/[:.]/g, "-")}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = () => {
      fetchConfigFileList();
    };

    document.getElementById("messageInput").addEventListener("input", function () {
      const hasText = this.value.trim().length > 0;
      document.getElementById("sendButton").disabled = !hasText;
    });

    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) ws.send("__ping__");
    }, 20000);
  </script>
</body>
</html>